<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">
<h:head>
   <title>Users</title>
   <style type="text/css">

      .custom-grid {
         width: 100%;
         padding: 20px;
         background-color: #f5f5f5;
         border-radius: 8px;
         box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .custom-label {
         font-weight: bold;
         margin-bottom: 5px;
         text-align: right;
         padding-right: 10px;
      }

      .custom-input {
         width: 100%;
      }

      .button-group {
         display: flex;
         justify-content: flex-end;
         margin-top: 20px;
      }

      .custom-button1 {
         margin-right: 10px;
         background-color: #1814F3 !important;
         border: #1814F3 !important;
      }

      .custom-button2 {
         margin-left: 10px !important;
         margin-right: 10px;
         background-color: #EC1212 !important;
         border: #EC1212 !important;
      }

      @font-face {
         font-family: Poppins;
         src: url("/resources/Poppins-Regular.ttf");
      }

      @font-face {
         font-family: Inter;
         src: url("/resources/Inter-Regular.ttf");
      }

      * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
         font-family: 'Inter', 'Arial', 'sans-serif';
      }

      body {
         min-height: 100vh;
         background-color: #F5F7FA;
         display: flex;
      }

      a {
         text-decoration: none;
      }

      li {
         list-style: none;
      }

      h1, h2 {
         color: #444;
      }

      .side-menu {
         background: white;
         border: 1px solid white;
         border-right-color: #E6EFF5;
         width: 16vw;
         min-height: 100vh;
         display: flex;
         flex-direction: column;
      }

      .side-menu .brand-name {
         height: 10vh;
         margin-top: 10px;
         font-family: 'Poppins', 'sans-serif';
         display: flex;
         color: #343C6A;
         align-items: center;
         justify-content: center;
      }

      .side-menu li {
         font-size: 16px;
         padding: 10px 40px;
         color: #B1B1B1;
         display: flex;
      }

      .side-menu li:hover {
         color: #2D60FF;
      }

      li svg use {
         fill: currentColor; /* Inherit color from parent */
         transition: fill 0.3s ease; /* Add a smooth transition */
      }

      li:hover svg use {
         fill: #2D60FF; /* Change to your desired hover color */
      }

      .container {
         flex: 1;
         display: flex;
         flex-direction: column;
         background-color: #f1f1f1;
      }

      .container .header {
         height: 13vh;
         background: white;
         display: flex;
         align-items: center;
         padding-left: 25px;
      }

      .container .content {
         flex: 1;
         overflow: auto;
      }

      .cards-title {
         padding: 10px 15px 0;
         margin-left: 25px;
         margin-top: 15px;
         margin-bottom: 0;
         font-size: 1.5rem; /* Adjust font size as needed */
         color: #343C6A;   /* Use a color that stands out */
      }

      .container .content .cards {
         padding: 25px 15px 5px;
         display: flex;
         align-items: center;
         justify-content: space-between;
         flex-wrap: wrap;
      }

      .container .content .cards .card {
         width: 340px;
         height: 120px;
         background: white;
         margin: 20px 10px;
         border-radius: 15px;
         display: flex;
         align-items: center;
         justify-content: space-around;
      }


      .container .content .charts {
         padding: 20px 15px;
         display: flex;
         align-items: center;
         justify-content: space-between;
         flex-wrap: wrap;
      }

      .container .content .charts .chart {
         width: calc(50% - 10px); /* Two charts per row with some spacing */
         height: 300px; /* Adjust height as needed */
         background: white;
         margin-bottom: 20px;
         border-radius: 15px;
         padding: 20px;
      }

      .chart h3 {
         color: #343C6A;
         margin-bottom: 10px;
      }

      .search-box {
         width: 800px;
         margin-right: 30px;
         margin-left: 45px;
         padding: 15px 30px 15px 10px;
         margin-top: 15px;
         border-radius: 5px;
         border: 1px solid #ccc;
         font-size: 14px;
         font-weight: lighter;
      }

      .search-button {
         width: 120px;
         margin-left: 10px;
         font-size: 18px;
         border-radius: 5px;
         background-color: #1814F3 !important;
         color: white;
         height: 32px;
         border: 0.5px #1814F3;
      }

      .table-format {
         margin: 10px 0 15px 20px;
         padding: 10px 0 15px 20px;
         width: 78vw;
      }

      .table-format .detail-rectangle {
         background: #E1E1E1;
         height: 60px;
         display: flex;
         align-items: center;
         justify-content: space-between;
      }

      .table-format .detail-rectangle .buttons-container {
         display: flex;
         align-items: center;
      }

      .table-format .detail-rectangle .box {
         justify-content: center;
         margin-top: 12px;
         margin-bottom: 16px;
         font-size: 16px;
         margin-left: 20px;
         flex-grow: 1;
      }

      .table-format .detail-rectangle .table-button1 {
         width: 100px;
         margin: 0 10px;
         height: 40px;
         font-size: 12px;
         background-color: #1814F3 !important;
         border: #1814F3 !important;
      }

      .table-format .detail-rectangle .table-button2 {
         width: 100px;
         height: 40px;
         margin: 0 10px;
         font-size: 12px;
         background-color: #EC1212 !important;
         border: #EC1212 !important;
      }

      .table-format .update-button {
         height: 35px;
         width: 50px;
         font-size: 13px;
         background-color: #1814F3 !important;
         border: #1814f3 !important;
      }

      .table-format .delete-button {
         height: 35px;
         width: 50px;
         font-size: 13px;
         margin-left: 0;
         background-color: #EC1212 !important;
         border: #EC1212 !important;
      }

      .dialog-button {
         margin: 20px;
      }

   </style>
   <script type="text/javascript">
      const timeoutWarning = 25 * 60 * 1000; // 25 minutes in milliseconds
      const sessionTimeout = 30 * 60 * 1000; // 30 minutes in milliseconds

      setTimeout(function() {
         alert('Your session will expire in 5 minutes. Please save your work.');
      }, timeoutWarning);

      setTimeout(function() {
         window.location.href = 'pages/login/login.xhtml';
      }, sessionTimeout);


      function handleSaveCompleteUpdate(xhr, status, args) {
         if (!args.validationFailed) {
            PF('updateUserDialog').hide();
         }
      }
      function handleRegisterCompleteUpdate(xhr, status, args) {
         if (!args.validationFailed) {
            PF('registerUserDialog').hide();
         }
      }
      function resetDialog() {
         // Assuming your dialog has a form with id 'updateUserForm'
         PF('updateUserDialog').hide(); // Hide the dialog
         // Reset form fields inside the dialog
         $('#updateUserForm').each(function() {
            this.reset();
         });
      }
   </script>
</h:head>
<h:body>
   <div class="side-menu">
      <div class="brand-name">
         <h1>Admin</h1>
      </div>
      <h:dataTable value="#{AdminMenu.menuItems}" var="item">
         <h:column>
            <ul>
               <li>
                  <h:link outcome="#{item.outcome}" onmouseover="this.style.color='#228BE6'" onmouseout="this.style.color='#B1B1B1'"  value="#{item.label}" style="text-decoration: none !important; color: #B1B1B1 !important;"/>
               </li>
            </ul>
         </h:column>
      </h:dataTable>
      <ul>
         <li>
            <h:form>
               <h:commandLink action="#{loginBean.logout()}" onmouseover="this.style.color='#EC1212'" onmouseout="this.style.color='#B1B1B1'" value="Logout" style="text-decoration: none !important; color: #B1B1B1 !important; margin-left: 2px"/>
            </h:form>
         </li>
      </ul>
   </div>
   <div class="container">
      <div class="header">
         <h1 style="margin-left: 25px">
            Users
         </h1>
      </div>
      <div class="content">
         <div class="cards">
            <div class="card">
               <div class="icon-case">
                  <h:graphicImage value="/resources/images/green.png" alt="Users W/D" width="70" height="70"/>
               </div>
               <div class="box">
                  <h3>Users with Dependants</h3>
                  <h1><h:outputText id="card1" value="#{AdminBean.usersWithDependantsCount()}"/></h1>
               </div>
            </div>
            <div class="card">
               <div class="icon-case">
                  <h:graphicImage value="/resources/images/red.png" alt="Users W'/D" width="70" height="70"/>
               </div>
               <div class="box">
                  <h3>Users without dependants</h3>
                  <h1><h:outputText id="card2" value="#{AdminBean.usersWithoutDependantsCount()}"/></h1>
               </div>
            </div>
            <div class="card">
               <div class="icon-case">
                  <h:graphicImage value="/resources/images/arrows.png" alt="Arrows" width="70" height="70"/>
               </div>
               <div class="box">
                  <h3>Dependency Ratio</h3>
                  <h1><h:outputText id="card3" value="#{AdminBean.ratioOfUsersWithDependantsToUsersWithout()}"/></h1>
               </div>
            </div>
         </div>
         <h2 class="cards-title">User Table</h2>
         <h:form id="searchForm">
            <p:inputText id="searchInput" value="#{userBean.searchQuery}" placeholder="Search by Username, First Name or Last Name" styleClass="search-box"/>
            <p:ajax event="keyup" update="userTablePanel" listener="#{userBean.searchUser}"/>

         </h:form>

         <div class="table-format">
            <div class="detail-rectangle">
               <div class="box">
                  <p><h:outputText id="card4" value="#{AdminBean.userCount()}"/> Users</p>
               </div>
               <div class="buttons-container">
               <h:form>
                  <p:commandButton value="Add New"
                                   icon="pi pi-user-plus"
                                   update=":registerForm userTablePanel card1 card2 card3 card4"
                                   oncomplete="PF('registerUserDialog').show()"
                                   styleClass="table-button1">
                  </p:commandButton>
               </h:form>
               <h:form>
                  <p:commandButton value="Delete All"
                                   icon="pi pi-user-minus"
                                   actionListener="#{userBean.confirmDeleteAll}"
                                   update="userTablePanel card1 card2 card3 card4"
                                   styleClass="table-button2">
                     <p:confirm header="Confirmation"
                                message="Are you absolutely sure you want to delete ALL users? This action cannot be undone!"
                                icon="pi pi-exclamation-triangle" />
                  </p:commandButton>
               </h:form>
               </div>
            </div>

            <h:panelGroup id="userTablePanel">
               <p:dataTable var="user" value="#{userBean.users}" rows="10"
                            paginator="true" paginatorPosition="bottom"
                            paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                            currentPageReportTemplate="{startRecord}-{endRecord} of {totalRecords} users"
                            rowsPerPageTemplate="5,10,{ShowAll|'All'}">

                  <p:column headerText="First Name">
                     <h:outputText value="#{user.firstname}"/>
                  </p:column>

                  <p:column headerText="Last Name">
                     <h:outputText value="#{user.lastname}"/>
                  </p:column>

                  <p:column headerText="Date of Birth">
                     <h:outputText value="#{user.dateOfBirth}">
                        <f:convertDateTime pattern="dd-MM-yyyy" timeZone="Africa/Kampala"/>
                     </h:outputText>
                  </p:column>

                  <p:column headerText="No. of Dependants">
                     <h:outputText value="#{AdminBean.activeDependantsCount(user)}"/>
                  </p:column>

                  <p:column headerText="Username">
                     <h:outputText value="#{user.username}"/>
                  </p:column>

                  <p:column headerText="Action">
                     <h:form>
                        <p:commandButton icon="pi pi-trash"
                                         update="userTablePanel card1 card2 card3 card4"
                                         actionListener="#{userBean.confirmDelete(user)}"
                                         styleClass="delete-button">
                           <p:confirm header="Confirmation" message="Are you sure you want to delete this user?"
                                      icon="pi pi-exclamation-triangle" />
                        </p:commandButton>
                        <p:commandButton icon="pi pi-user-edit"
                                         actionListener="#{userBean.selectUser(user)}"
                                         update=":updateForm userTablePanel card1 card2 card3 card4"
                                         oncomplete="PF('updateUserDialog').show()"
                                         styleClass="update-button" style="margin-left: 5px">
                        </p:commandButton>
                     </h:form>
                  </p:column>

                  <f:facet name="paginatorTopLeft">
                     <p:commandButton type="button" icon="pi pi-refresh"/>
                  </f:facet>

               </p:dataTable>
            </h:panelGroup>
         </div>
      </div>
   </div>

   <h:form id="updateForm">
      <p:dialog header="Update User: #{userBean.selectedUser.username}"
                widgetVar="updateUserDialog"
                modal="true"
                resizable="true"
                showEffect="fade"
                hideEffect="fade"
                closable="true"
                width="800px"
                visible="#{facesContext.validationFailed}"
      >

         <p:outputPanel id="updatePanel" rendered="#{not empty userBean.selectedUser}">

            <p:messages id="updatemessages" showDetail="false" closable="true" severity="error" showSummary="true">
               <p:autoUpdate/>
            </p:messages>
            <p:growl id="growl" showDetail="false" severity="info"/>

            <p:panelGrid columns="2" styleClass="custom-grid">

               <p:outputLabel for="email" styleClass="custom-label">Email:     </p:outputLabel>
               <p:inputText id="email" value="#{userBean.selectedUser.email}" required="true" styleClass="custom-input">
                  <!-- <f:validateRegex pattern="^[\\w.-]+@[\\w.-]+\\.[a-zA-Z]{2,}$" /> -->
               </p:inputText>

               <p:outputLabel for="firstname" styleClass="custom-label">First Name:</p:outputLabel>
               <p:inputText id="firstname" value="#{userBean.selectedUser.firstname}" required="true" styleClass="custom-input">
                  <f:validateRegex pattern="[a-zA-Z]*" />
                  <f:validateLength minimum="3" maximum="32" />
               </p:inputText>

               <p:outputLabel for="lastname" styleClass="custom-label">Last Name:</p:outputLabel>
               <p:inputText id="lastname" value="#{userBean.selectedUser.lastname}" required="true" styleClass="custom-input">
                  <f:validateRegex pattern="[a-zA-Z]*" />
                  <f:validateLength minimum="3" maximum="32" />
               </p:inputText>

               <p:outputLabel for="password" styleClass="custom-label">Password:</p:outputLabel>
               <p:password id="password" value="#{userBean.selectedUser.password}" required="true" styleClass="custom-input">
               </p:password>

               <p:outputLabel for="dateOfBirth" styleClass="custom-label">Date of Birth:</p:outputLabel>
               <p:datePicker id="dateOfBirth" value="#{userBean.selectedUser.dateOfBirth}"
                             pattern="dd-MM-yyyy"
                             showOnFocus="true"
                             showTime="false" timeInput="false"
                             maxdate="#{calendarBean.currentDate}" styleClass="custom-input"/>
               <h:message for="dateOfBirth" styleClass="error" />
            </p:panelGrid>

            <div class="button-group">
               <p:commandButton value="Save" update=":updateForm:updatePanel userTablePanel card1 card2 card3 card4" actionListener="#{userBean.updateUser}" oncomplete="handleSaveCompleteUpdate(xhr, status, args)" icon="pi pi-check" styleClass="custom-button1"/>
               <p:commandButton value="Cancel" onclick="resetDialog();" icon="pi pi-times" styleClass="custom-button2"/>
            </div>
         </p:outputPanel>
      </p:dialog>
   </h:form>

   <h:form id="registerForm">
      <p:dialog header="Register New User."
                widgetVar="registerUserDialog"
                modal="true"
                resizable="true"
                showEffect="fade"
                hideEffect="fade"
                closable="true"
                width="800px"
                visible="#{facesContext.validationFailed}"
      >
         <p:outputPanel id="registerPanel" rendered="true">

            <p:messages id="registermessages" showDetail="false" closable="true" severity="error, info" showSummary="true">
               <p:autoUpdate/>
            </p:messages>

            <p:panelGrid columns="2" styleClass="custom-grid">
               <p:outputLabel for="userusername" styleClass="custom-label">Username:</p:outputLabel>
               <p:inputText id="userusername" value="#{userBean.user.username}" required="true" validatorMessage="User name is required" styleClass="custom-input">
                  <f:validateRegex pattern="[a-zA-Z0-9_]*" />
                  <f:validateLength minimum="3" maximum="16" />
                  <f:validateRequired/>
               </p:inputText>

               <p:outputLabel for="useremail" styleClass="custom-label">Email:     </p:outputLabel>
               <p:inputText id="useremail" value="#{userBean.user.email}" required="true" styleClass="custom-input">
                  <!-- <f:validateRegex pattern="^[\\w.-]+@[\\w.-]+\\.[a-zA-Z]{2,}$" /> -->
               </p:inputText>

               <p:outputLabel for="userfirstname" styleClass="custom-label">First Name:</p:outputLabel>
               <p:inputText id="userfirstname" value="#{userBean.user.firstname}" required="true" validatorMessage="First Name is required" styleClass="custom-input">
                  <f:validateRegex pattern="[a-zA-Z ]*" />
                  <f:validateLength minimum="3" maximum="32" />
                  <f:validateRequired/>
               </p:inputText>

               <p:outputLabel for="userlastname" styleClass="custom-label">Last Name:</p:outputLabel>
               <p:inputText id="userlastname" value="#{userBean.user.lastname}" required="true" validatorMessage="Last Name is required" styleClass="custom-input">
                  <f:validateRegex pattern="[a-zA-Z ]*" />
                  <f:validateLength minimum="3" maximum="32" />
                  <f:validateRequired/>
               </p:inputText>

               <p:outputLabel for="userdateOfBirth" styleClass="custom-label">Date of Birth:</p:outputLabel>
               <p:datePicker id="userdateOfBirth" value="#{userBean.user.dateOfBirth}"
                             pattern="dd-MM-yyyy"
                             showOnFocus="true"
                             showTime="false" timeInput="false"
                             maxdate="#{calendarBean.currentDate}" styleClass="custom-input"/>

            </p:panelGrid>

            <div class="button-group">
               <p:commandButton value="Register" update=":registerForm:registerPanel userTablePanel card1 card2 card3 card4" actionListener="#{userBean.registerUser}" icon="pi pi-check" styleClass="custom-button1"/>
               <p:commandButton value="Cancel" onclick="PF('registerUserDialog').hide();" icon="pi pi-times" styleClass="custom-button2"/>
            </div>

         </p:outputPanel>
      </p:dialog>
   </h:form>

   <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
      <p:button value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check" style="background-color: #EC1212 !important;"/>
      <p:button value="No" type="button" styleClass="ui-confirmdialog-no" icon="pi pi-times" style="background-color: #1814F3 !important;"/>
   </p:confirmDialog>

</h:body>
</html>
